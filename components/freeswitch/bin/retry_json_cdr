#!/usr/bin/env bash

REQUIRED_ENV_VARS=("FS_LOG_DIRECTORY" "FS_MOD_JSON_CDR_URL")
MOD_JSON_CDR_USER="services"

# Loop through and check if each is set
for var in "${REQUIRED_ENV_VARS[@]}"; do
  if [[ -z "${!var}" ]]; then
    echo "Error: $var environment variable is not set."
    exit 1
  fi
done

encoding="${1:-base64}"
if [[ "$encoding" != "base64" && "$encoding" != "json" ]]; then
  echo "Usage: $0 [base64|json]"
  exit 1
fi

for file in "$FS_LOG_DIRECTORY"/*.json; do
  if [[ -f "$file" ]]; then
    if [[ "$encoding" == "base64" ]]; then
      content=$(<"$file")
    else
      content=$(base64 "$file")
    fi

    http_status=$(curl -s -o /dev/null -w "%{http_code}" "$FS_MOD_JSON_CDR_URL" \
      -H "Content-Type: application/x-www-form-base64-encoded" \
      -u "${MOD_JSON_CDR_USER}:${FS_MOD_JSON_CDR_PASSWORD}" \
      --data "cdr=$content")

    if [[ "$http_status" =~ ^2 ]]; then
      echo "Upload successful (HTTP $http_status), removing $file"
      rm "$file"
    else
      echo "Upload failed (HTTP $http_status), keeping $file"
    fi
  fi
done
